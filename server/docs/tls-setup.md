# TLS Setup

Secure transports are optional but recommended for any deployment that runs outside an isolated development machine. The server exposes both gRPC (`:50051`) and WebSocket (`:8080`) listeners, and the same TLS certificate/key pair is used for both when enabled.

## Configuration

Set the following environment variables before starting `cmd/emdash-server`:

| Variable | Default | Description |
| --- | --- | --- |
| `TLS_ENABLED` | `false` | Set to `true` to enable TLS for gRPC and WebSocket listeners. |
| `TLS_CERT_FILE` | `certs/server.crt` | Path to the PEM encoded certificate. |
| `TLS_KEY_FILE` | `certs/server.key` | Path to the PEM encoded RSA private key. |

If `TLS_ENABLED=true`, both files must exist; the server fails fast with a clear error when it cannot read either file.

## Development (self-signed certificates)

1. Generate a certificate/key pair (valid for localhost):
   ```bash
   cd server
   ./scripts/gen-cert.sh
   ```
2. Export the environment variables (paths are relative to `server/`):
   ```bash
   export TLS_ENABLED=true
   export TLS_CERT_FILE=certs/server.crt
   export TLS_KEY_FILE=certs/server.key
   ```
3. Start the server (`go run ./cmd/emdash-server` or `go build` + run).

### Testing self-signed certificates

- **gRPC:** Use [`grpcurl`](https://github.com/fullstorydev/grpcurl) with the generated certificate as the trusted CA.
  ```bash
  cd server
  grpcurl -cacert certs/server.crt localhost:50051 list
  ```
- **WebSocket:** Many clients reject self-signed certificates by default. Use a client that can skip verification during local testing, e.g. [`wscat`](https://github.com/websockets/wscat):
  ```bash
  wscat --no-check -c wss://localhost:8080/ws/pty?token=<JWT>
  ```
  Replace `<JWT>` with a valid token generated by the server.

## Production (Let's Encrypt example)

1. Provision DNS for the hostnames that will terminate TLS (e.g. `api.example.com`).
2. Install [Certbot](https://certbot.eff.org/) on the server and request a certificate:
   ```bash
   sudo certbot certonly --standalone -d api.example.com
   ```
   This generates files such as `/etc/letsencrypt/live/api.example.com/fullchain.pem` and `privkey.pem`.
3. Configure the server to point at those files:
   ```bash
   export TLS_ENABLED=true
   export TLS_CERT_FILE=/etc/letsencrypt/live/api.example.com/fullchain.pem
   export TLS_KEY_FILE=/etc/letsencrypt/live/api.example.com/privkey.pem
   ```
4. Reload or restart the emdash server.
5. Automate renewal by running `certbot renew` via cron/systemd and reloading the server after certificates refresh.

For production, keep private keys readable only by the service user and monitor certificate expiration to avoid outages.
